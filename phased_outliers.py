#!/usr/bin/env python
import numpy as np
import warnings
import matplotlib.pyplot as plt
import pandas as pd
from astropy.stats import LombScargle
from matplotlib import rc
#rc('text', usetex=True)
#rc('font', family='serif',size=12)

stars = ['cepheid','eclipse_binary','RR_lyrae']
#stars = ['RR_lyrae']
formal = ['Cepheid', 'Eclipse Binary', 'RR Lyrae']
#formal = ['RR Lyrae']
star_names = {star:form for star, form in zip(stars,formal)}
file_counts = [4586, 3633, 2172]
#file_counts = [2172]

star_means = [
    [0.023633972921693103, 0.029301709779818403, 0.035204871506521164, 0.04064526821566002, 0.04641287693393389, 0.052038304071670476, 0.05729337108133021, 0.06235901370715149, 0.06688269748712448, 0.07243452720828893, 0.07686040985641847, 0.08125583213145449, 0.08591758244494829, 0.08997854167608255, 0.09467221193533157, 0.09842056197631344, 0.10228967853523811, 0.10588025801116167, 0.11000991110636406, 0.1132807168058164, 0.11673727596537088, 0.12010904574623185, 0.1229625967601813, 0.12609113698730504, 0.12926251738650296, 0.13133159445840642, 0.13386252303043483, 0.1368004881004752, 0.13893415668970735, 0.14053368730819413, 0.1423637515991826, 0.14519349598615852, 0.1459478829559142, 0.14676987240302244, 0.14878574313741477, 0.14884674281694513, 0.1493837900083255, 0.14896059568437903, 0.14816413643240176, 0.14485888576302847, 0.14250775930989854, 0.13824375713879394, 0.1326196344345278, 0.12483038905954805, 0.11522714587991802, 0.10169033831377776, 0.08510614128792915, 0.06726355264063212, 0.046215712535760525, 0.02304188219170738, -0.004321181655364451, -0.03165443057928209, -0.06060368682501083, -0.08914575760562754, -0.11527661974761633, -0.13884361333913156, -0.15990255810497836, -0.17492919595649917, -0.18590125543843475, -0.19383135860987338, -0.1983311626053532, -0.19937920061710596, -0.19739824791254246, -0.19582834688655776, -0.19332673139496662, -0.1887782957635454, -0.18397112559613155, -0.17826158670685624, -0.17353903630699719, -0.16777635732803187, -0.16141834424407708, -0.15562930182027132, -0.1487950695378474, -0.14289197157407849, -0.13682653114036933, -0.1301541752386346, -0.1244433743426647, -0.11805316157527296, -0.11152868792447895, -0.10556699224217375, -0.09964985743833568, -0.09341737753906784, -0.08696523637309304, -0.08106910539422488, -0.07466397424877946, -0.06837106936617425, -0.062492231880781374, -0.056065146635929874, -0.050180512294975575, -0.04429013683469486, -0.03750014858293452, -0.03148923512088393, -0.025194367554704854, -0.019497659821263617, -0.013011925927106498, -0.007162122513735974, -0.0013750171405345778, 0.004828498103599521, 0.011160059138442346, 0.016999013391171696],
    [-0.06342369422099017, -0.06188793161447613, -0.0607141253961855, -0.059564541775339076, -0.057222272481094044, -0.055035260590534194, -0.051604467809394226, -0.0489982518086725, -0.04475885663194591, -0.0403777875413041, -0.03682004935780037, -0.032587748770747084, -0.02782043234311184, -0.02166557022920957, -0.015068879919137442, -0.007016972423817923, 0.0037273048682321, 0.01891500728798306, 0.038674359453172866, 0.06419274784515193, 0.09725743589029016, 0.1370524558340303, 0.1770646248947799, 0.21028381068418944, 0.23121265724987977, 0.25853172765541615, 0.21130179127981652, 0.1752799613184765, 0.13492246850778333, 0.09672080764569999, 0.06376490161974331, 0.03533249828379412, 0.016604376943299002, 0.0010235579062443916, -0.009494014529915277, -0.017719755234477764, -0.024329926910715845, -0.02999005612729042, -0.03488144132680734, -0.03819277521806102, -0.04244092694519977, -0.046282585528408415, -0.050490487593499854, -0.05290226136937553, -0.0552903226172813, -0.057918693305475194, -0.059924048963402976, -0.062193563830956484, -0.06283623631671091, -0.06326752522046561, -0.06370526451061705, -0.0640434701501876, -0.06330753683939518, -0.0618518008853179, -0.060524395043986025, -0.05856011152954415, -0.057236994565036836, -0.0550710124799633, -0.05189861967055818, -0.04795298618463807, -0.04488031754609436, -0.04111659623471905, -0.03666271946258901, -0.031938424572962684, -0.026385169475436225, -0.018583315860167322, -0.008921777484314882, 0.0028370835921423957, 0.017092207347041546, 0.03480415453892616, 0.05353497299468154, 0.07307811413641276, 0.09362009538974146, 0.10818558628418436, 0.11872555242702253, 0.1194176755661308, 0.10954662298134396, 0.09121333247934839, 0.07281043950550939, 0.053088209193841496, 0.033573136581050204, 0.016283571379045698, 0.001859209874062877, -0.009178606757923667, -0.018916893904717694, -0.025463878578716216, -0.0323169622203896, -0.036664872483385624, -0.0418549808200282, -0.04595858496632357, -0.048775533492417866, -0.052806235640288246, -0.054929201713404936, -0.056838672693114344, -0.05940685395602452, -0.061375710259628055, -0.06168185162570379, -0.06284626442874786, -0.0634214122855556, -0.06344303252452459],
    [0.02482290036692272, 0.031175632523735942, 0.03957835967900999, 0.04558892201436848, 0.05162832304789814, 0.05687223356525178, 0.06385991078619323, 0.06934059819804134, 0.07450681280885312, 0.08027568842824298, 0.08561951467095794, 0.08992669512544846, 0.09590342492701848, 0.10040571611350675, 0.10486770642487812, 0.10708804554643826, 0.11085071250412193, 0.11499208678370121, 0.1163107599162326, 0.12012108194205984, 0.12264004429461044, 0.12473512552279545, 0.12745818162341296, 0.12984273261466173, 0.13014855086607424, 0.13118213555969885, 0.13325069334094963, 0.13473654863247242, 0.13754277396209127, 0.14000847579435163, 0.14189947436027045, 0.14479226718719063, 0.1450275939307304, 0.14883375921685402, 0.15174456472128062, 0.15376162534721524, 0.157127022076482, 0.15991536276655893, 0.16200266098476698, 0.16468045089891095, 0.16350213873750977, 0.15821095292588286, 0.15382163369549132, 0.14440386580245632, 0.13108226651251323, 0.1140383006006765, 0.092106240128131, 0.0691415708405862, 0.04296812545237859, 0.017532017980964883, -0.01525707392810092, -0.043199731155407574, -0.07042249493931471, -0.09878661229892306, -0.1259046554455532, -0.14797431311626677, -0.1707661500502244, -0.18903294176614724, -0.20292498436287526, -0.209438305394457, -0.21381580954520113, -0.21297566410011762, -0.2150407806246336, -0.20977052878319605, -0.20320645612037033, -0.1984154240550747, -0.19213835105150665, -0.18780095853164355, -0.18195214923146238, -0.1754309978654617, -0.16717745502328113, -0.1588928452658163, -0.15274751999829964, -0.14615456263696014, -0.13987088379766557, -0.13350713586828575, -0.1263295165437661, -0.12161713724111131, -0.11461329865345184, -0.10912324561887862, -0.10327429918382158, -0.09715790839204862, -0.09089148689110778, -0.08457305999369066, -0.07885917231937345, -0.0698020451301913, -0.0658582496800525, -0.05962815800940674, -0.0537456497348972, -0.04719568655157246, -0.04118141307773708, -0.03468983719123994, -0.02858976937473681, -0.02231276191944679, -0.016302190464376132, -0.009703467724741477, -0.00278910727012784, 0.004563348905297183, 0.011186984588945306, 0.017351657632334264]
]

#star_means = [
#[16.38424471276805, 16.384128783777133, 16.397883251848757, 16.390098114131767, 16.400369671970143, 16.422018625656047, 16.42220044614404, 16.42299114697011, 16.429270114519728, 16.431318691888425, 16.435302650685436, 16.435677183635562, 16.44570230799644, 16.449430068124247, 16.459827169829733, 16.449373436114666, 16.459791249083352, 16.465387333989177, 16.465994280642935, 16.472060130143355, 16.47578678338059, 16.474553199862267, 16.484699221411194, 16.4858676564574, 16.48362096419675, 16.486424417177908, 16.494046995073894, 16.493524565270633, 16.49522601248012, 16.500599305096774, 16.499286590019448, 16.496282706951607, 16.50333219152764, 16.50336753993926, 16.502270889255545, 16.50728886214012, 16.505427275192933, 16.513160160184754, 16.507401314493897, 16.507861129373946, 16.504982294166627, 16.49526681923323, 16.48862597651452, 16.479747096584504, 16.470963013191962, 16.470879579082577, 16.445086089958618, 16.425899290675332, 16.40306332408476, 16.384034675861397, 16.351095327421557, 16.324475071295115, 16.301767981664803, 16.265177495303387, 16.244342923151752, 16.217653243737338, 16.200584378704068, 16.17665663900415, 16.175785673818265, 16.163797239316448, 16.158023166495425, 16.16229758831772, 16.16128195035548, 16.15829089662938, 16.165142983143863, 16.172188545089, 16.176408571990947, 16.173941825328583, 16.184574971870262, 16.197855818617622, 16.208397081014226, 16.203244130424174, 16.213077390579816, 16.208783665556496, 16.21768707665319, 16.232515037686284, 16.226691126946164, 16.241654143241263, 16.247895150624537, 16.25828481477852, 16.257248932724863, 16.270254387480563, 16.280416017009212, 16.28198326255929, 16.283044768784706, 16.2921856911606, 16.305292174809214, 16.306548916227303, 16.301563625972218, 16.309745059482843, 16.328962267401792, 16.325634813290204, 16.33458740675304, 16.339327879725847, 16.345138117455377, 16.352995201108197, 16.357436724078713, 16.358596672123536, 16.367920271292295, 16.377091866617448],
#[17.613139123254232, 17.625614808174973, 17.629751599335528, 17.629992947210944, 17.61570607246741, 17.62279131582703, 17.625518085678436, 17.61826279401283, 17.634609755224737, 17.636350158854814, 17.637628334997856, 17.64413097077957, 17.666830867796854, 17.65538727670691, 17.667820108462966, 17.670396997648762, 17.681896591565568, 17.712329088639205, 17.725993537036373, 17.759092234065694, 17.786660983890773, 17.82242044511777, 17.856498526663795, 17.89462503654971, 17.90485398956547, 17.93985923530531, 17.884684592232656, 17.856017167381975, 17.821777344309236, 17.78982857764403, 17.750674118535024, 17.729666931150142, 17.694963682644392, 17.683553098290595, 17.674513052858686, 17.667581446911992, 17.64885126262626, 17.64905832644108, 17.65308328555046, 17.643587659787187, 17.62838113234455, 17.64379980668027, 17.644580012196435, 17.641941700638554, 17.628393401649586, 17.620554135579912, 17.62016862902344, 17.627637470107434, 17.62397202797203, 17.612800213181735, 17.61196444681229, 17.610553250740832, 17.61504561315155, 17.61915656169849, 17.61093915353412, 17.6103946936152, 17.62434610103346, 17.633440217785843, 17.621920892203974, 17.621887092727338, 17.645228704700397, 17.64864951550041, 17.631189956175014, 17.64901470745725, 17.664609566421646, 17.652375013579576, 17.675758764876164, 17.691879163495344, 17.69479389939351, 17.725364185693092, 17.723884478609147, 17.762024171344798, 17.778925562357372, 17.779414407548536, 17.801199312217193, 17.811564193982612, 17.800135547576303, 17.766539056040834, 17.759988384637513, 17.750091376811593, 17.72204884531121, 17.69752170154522, 17.683091897303868, 17.676353810292273, 17.65578855462727, 17.654986557589737, 17.659972943526423, 17.66106473754561, 17.641131178977272, 17.64187620102154, 17.640978501581824, 17.633007002298193, 17.627674944694213, 17.6239668998828, 17.627574253185337, 17.622903094784515, 17.612812409551374, 17.607732178500143, 17.59747701313535, 17.60075067442851],
#[19.141788402435484, 19.144362605907947, 19.15310374555834, 19.159690314656682, 19.16241589948469, 19.16638945031836, 19.170062871806834, 19.187111362581245, 19.18984364330768, 19.195243340075123, 19.19100348740986, 19.203011102580763, 19.20506114537445, 19.21724745243565, 19.214763270322468, 19.215437994722954, 19.21824492164829, 19.2265902721009, 19.22605723498589, 19.235981430975453, 19.23353386592567, 19.240848557271935, 19.243934462616824, 19.24402129817444, 19.249949010477298, 19.24584435372585, 19.246225761288066, 19.245687583912208, 19.24661393552916, 19.25541167934057, 19.25216920130021, 19.2564520324255, 19.252838080260936, 19.268931175747646, 19.270757782839787, 19.25673070819865, 19.268522496201935, 19.273668940586553, 19.269941248185777, 19.282384308198264, 19.278578812870254, 19.265384317408145, 19.265673114233643, 19.260185432385374, 19.244778641233953, 19.229715337779066, 19.205258660101986, 19.181860904209252, 19.156765711966607, 19.12518272095333, 19.102116177498253, 19.06740711015992, 19.04605768433521, 19.012457749369613, 18.988877604776395, 18.95940008166122, 18.942596351594727, 18.919698072067938, 18.910291615684905, 18.90022759635187, 18.89903980593874, 18.898690225301277, 18.896482001397946, 18.904668459092225, 18.916570204273302, 18.909245444059977, 18.92003144104804, 18.919921581296993, 18.93227667960937, 18.938393470290404, 18.943350901606077, 18.95268522284851, 18.957866597486454, 18.96081883292239, 18.978242043357934, 18.974867488802282, 18.98814546310463, 18.990350430373777, 18.999005321326237, 19.00330539649488, 19.013524456680916, 19.01413188086684, 19.018566820816012, 19.028501134710503, 19.026745093498523, 19.035319695472772, 19.051327604411078, 19.053521361973328, 19.05759649841902, 19.063092752272198, 19.069839828366543, 19.07936362570356, 19.085279976442873, 19.08723235277252, 19.098756972819327, 19.10293597665637, 19.10343328327172, 19.116802917569867, 19.12300836501901, 19.129731031242663]
#]

#star_means = [
#    [0.02482290036692272, 0.031175632523735942, 0.03957835967900999, 0.04558892201436848, 0.05162832304789814, 0.05687223356525178, 0.06385991078619323, 0.06934059819804134, 0.07450681280885312, 0.08027568842824298, 0.08561951467095794, 0.08992669512544846, 0.09590342492701848, 0.10040571611350675, 0.10486770642487812, 0.10708804554643826, 0.11085071250412193, 0.11499208678370121, 0.1163107599162326, 0.12012108194205984, 0.12264004429461044, 0.12473512552279545, 0.12745818162341296, 0.12984273261466173, 0.13014855086607424, 0.13118213555969885, 0.13325069334094963, 0.13473654863247242, 0.13754277396209127, 0.14000847579435163, 0.14189947436027045, 0.14479226718719063, 0.1450275939307304, 0.14883375921685402, 0.15174456472128062, 0.15376162534721524, 0.157127022076482, 0.15991536276655893, 0.16200266098476698, 0.16468045089891095, 0.16350213873750977, 0.15821095292588286, 0.15382163369549132, 0.14440386580245632, 0.13108226651251323, 0.1140383006006765, 0.092106240128131, 0.0691415708405862, 0.04296812545237859, 0.017532017980964883, -0.01525707392810092, -0.043199731155407574, -0.07042249493931471, -0.09878661229892306, -0.1259046554455532, -0.14797431311626677, -0.1707661500502244, -0.18903294176614724, -0.20292498436287526, -0.209438305394457, -0.21381580954520113, -0.21297566410011762, -0.2150407806246336, -0.20977052878319605, -0.20320645612037033, -0.1984154240550747, -0.19213835105150665, -0.18780095853164355, -0.18195214923146238, -0.1754309978654617, -0.16717745502328113, -0.1588928452658163, -0.15274751999829964, -0.14615456263696014, -0.13987088379766557, -0.13350713586828575, -0.1263295165437661, -0.12161713724111131, -0.11461329865345184, -0.10912324561887862, -0.10327429918382158, -0.09715790839204862, -0.09089148689110778, -0.08457305999369066, -0.07885917231937345, -0.0698020451301913, -0.0658582496800525, -0.05962815800940674, -0.0537456497348972, -0.04719568655157246, -0.04118141307773708, -0.03468983719123994, -0.02858976937473681, -0.02231276191944679, -0.016302190464376132, -0.009703467724741477, -0.00278910727012784, 0.004563348905297183, 0.011186984588945306, 0.017351657632334264]
#]


def plot_period_std(ax, mean, std):
    ax.plot(np.linspace(0,1,len(mean)),mean+std, 'r-', alpha=0.3)
    ax.plot(np.linspace(0,1,len(mean)),mean-std, 'r-', alpha=0.3)
    ax.fill_between(np.linspace(0,1,len(mean)), mean-std, mean+std, alpha=0.1)
    ax.plot(np.linspace(0,1,len(mean)),mean, alpha=0.3)

def plot_outliers(ax, outlier, c, alpha):
    ax.plot(np.linspace(0,1,len(outlier)),outlier, c + '-', alpha=alpha)

def find_anomalies_mean_L1(dfC, star):
    df_min, df_max = [dfC.min().min(), dfC.max().max()]
    fig = plt.figure()
    ax_count = 1
    class_mean, class_std = dfC.mean(0), dfC.std(0)
    dfCL1 = df.subtract(class_mean, axis=1)
    dfCL1 = dfCL1.abs()
    dfC["L1"] = dfCL1.sum(axis=1)
    q3 = dfC["L1"].quantile(0.75)
    q1 = dfC["L1"].quantile(0.25)
    iqr = q3-q1
    dfCOutliers = dfC[(dfC.L1>q3+1.5*iqr) | (dfC.L1<q1-1.5*iqr)]
    dfCOutliers.drop('L1', axis=1, inplace=True)
    print(star, ": ", dfC.shape[0], " outliers: ", dfCOutliers.shape[0])


for count, star in enumerate(stars):
    num_files = file_counts[count]
    mags_dict = {}
    mag_ers_dict = {}
    time_dict = {}
    sl = []
    for i in range(num_files-1):
        if i%1000==0:print(star,i)
        with open('phased_{0}/ogle{1}.txt'.format(star,i+1)) as f:
            length = sum(1 for line in f)
            time = np.zeros(length)
            mags = np.zeros(length)
            mag_ers = np.zeros(length)
            f.seek(0)
            for j,line in enumerate(f):
                time[j], mags[j], mag_ers[j] = line.split(' ')[-3:]
        
        mag_av = np.mean(mags)
        mags-=mag_av
        bins = np.linspace(0, 1, 101)
        bin_phase = np.digitize(time, bins)
        mags_bins = [mags[bin_phase == i].mean() if mags[bin_phase == i].size else star_means[count][i-1] for i in range(1, len(bins))]
        mags_bins = [ i-j for i, j in zip(mags_bins, star_means[count])]
        sl.append(mags_bins)

    df = pd.DataFrame(sl)
    find_anomalies_mean_L1(df, star)